name: Emergency Release Cleanup

on:
  workflow_dispatch:
    inputs:
      target_tag:
        description: 'ç›®æ ‡å‘å¸ƒæ ‡ç­¾ (Target Release Tag)'
        required: true
        type: string
      issue_type:
        description: 'é—®é¢˜ç±»å‹ (Issue Type)'
        required: true
        type: choice
        options:
          - Normal
          - Bug
          - Critical
      reference:
        description: 'é—®é¢˜é“¾æ¥æˆ–è¯´æ˜ (Issue link or description, optional)'
        required: false
        type: string

jobs:
  cleanup:
    runs-on: ubuntu-latest
    # ä»…å…è®¸ä»“åº“æ‰€æœ‰è€…æ‰§è¡Œ
    if: github.actor == github.repository_owner

    steps:
      # ==================== éªŒè¯å‘å¸ƒæ˜¯å¦å­˜åœ¨ ====================
      - name: éªŒè¯ Release å­˜åœ¨
        run: |
          if ! gh release view "${{ inputs.target_tag }}" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "::error::Release '${{ inputs.target_tag }}' ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ° Release: ${{ inputs.target_tag }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==================== è·å–åŸå§‹å‘å¸ƒä¿¡æ¯ ====================
      - name: è·å–åŸå§‹å‘å¸ƒä¿¡æ¯
        id: info
        run: |
          gh release view "${{ inputs.target_tag }}" --repo ${{ github.repository }} \
            --json name,body,isPrerelease > release_info.json

          jq -r '.name' release_info.json > original_title.txt
          jq -r '.body' release_info.json > original_body.txt

          IS_PRERELEASE=$(jq -r '.isPrerelease' release_info.json)
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ åŸæ ‡é¢˜: $(cat original_title.txt)"
          echo "ğŸ“‹ Pre-release: $IS_PRERELEASE"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==================== å¤„ç† Normal ç±»å‹ ====================
      - name: å¤„ç† Normal ç±»å‹ - æ ‡è®°æ­£å¸¸
        if: inputs.issue_type == 'Normal'
        run: |
          cat > new_body.md << 'EOF'
          > [!TIP]
          > **æ­¤ç‰ˆæœ¬å·²éªŒè¯ï¼Œå¯æ­£å¸¸ä½¿ç”¨ã€‚**
          >
          > **This release has been verified and is safe to use.**
          EOF

          sed -i 's/^          //' new_body.md

          if [ -n "${{ inputs.reference }}" ]; then
            echo "" >> new_body.md
            echo "**å‚è€ƒ / Reference**: ${{ inputs.reference }}" >> new_body.md
          fi

          echo "" >> new_body.md
          echo "---" >> new_body.md
          echo "" >> new_body.md
          cat original_body.txt >> new_body.md

          gh release edit "${{ inputs.target_tag }}" --repo ${{ github.repository }} \
            --notes-file new_body.md

          echo "âœ… å·²æ ‡è®° Release ä¸ºæ­£å¸¸ (Normal)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==================== å¤„ç† Bug ç±»å‹ ====================
      - name: å¤„ç† Bug ç±»å‹
        if: inputs.issue_type == 'Bug'
        run: |
          cat > new_body.md << 'EOF'
          > [!WARNING]
          > **æ­¤ç‰ˆæœ¬å­˜åœ¨å·²çŸ¥ Bugï¼Œå»ºè®®è°¨æ…ä½¿ç”¨ã€‚**
          >
          > **This release contains known bugs, use with caution.**
          EOF

          sed -i 's/^          //' new_body.md

          if [ -n "${{ inputs.reference }}" ]; then
            echo "" >> new_body.md
            echo "**å‚è€ƒ / Reference**: ${{ inputs.reference }}" >> new_body.md
          fi

          echo "" >> new_body.md
          echo "---" >> new_body.md
          echo "" >> new_body.md
          cat original_body.txt >> new_body.md

          gh release edit "${{ inputs.target_tag }}" --repo ${{ github.repository }} \
            --notes-file new_body.md

          echo "âœ… å·²æ›´æ–° Release è¯´æ˜ (Bug)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==================== å¤„ç† Critical ç±»å‹ ====================
      - name: å¤„ç† Critical ç±»å‹ - åˆ é™¤å¹¶é‡å»º
        if: inputs.issue_type == 'Critical'
        run: |
          ORIGINAL_TITLE=$(cat original_title.txt)

          # æ„å»ºè­¦å‘Šä¿¡æ¯
          cat > new_body.md << 'EOF'
          > [!CAUTION]
          > **æœ¬æ¬¡å‘å¸ƒçš„èµ„æºåŒ…å«å¯¼è‡´æ­»æœºçš„ä¸¥é‡ Bugï¼Œæ‰€æœ‰é™„ä»¶å·²è¢«æ¸…é™¤ï¼**
          >
          > **è¯·å‹¿ä½¿ç”¨æ­¤ç‰ˆæœ¬ï¼Œç­‰å¾…ä¿®å¤ç‰ˆæœ¬å‘å¸ƒã€‚**
          >
          > **This release contained a critical bug causing device crashes. All assets have been removed!**
          >
          > **DO NOT use this version. Please wait for a fixed release.**
          EOF

          sed -i 's/^          //' new_body.md

          if [ -n "${{ inputs.reference }}" ]; then
            echo "" >> new_body.md
            echo "**å‚è€ƒ / Reference**: ${{ inputs.reference }}" >> new_body.md
          fi

          echo "" >> new_body.md
          echo "---" >> new_body.md
          echo "" >> new_body.md
          cat original_body.txt >> new_body.md

          # åˆ é™¤ Releaseï¼ˆä¿ç•™ Git Tagï¼‰
          echo "ğŸ—‘ï¸ åˆ é™¤åŸ Release..."
          gh release delete "${{ inputs.target_tag }}" --repo ${{ github.repository }} --yes

          # ç¡®å®š prerelease æ ‡å¿—
          PRERELEASE_FLAG=""
          if [ "${{ steps.info.outputs.is_prerelease }}" == "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          # é‡å»º Releaseï¼ˆä¸ä¸Šä¼ ä»»ä½•æ–‡ä»¶ï¼‰
          echo "ğŸ”„ é‡å»º Release..."
          gh release create "${{ inputs.target_tag }}" --repo ${{ github.repository }} \
            --title "$ORIGINAL_TITLE" \
            --notes-file new_body.md \
            $PRERELEASE_FLAG

          echo "âœ… å·²æ¸…é™¤æ‰€æœ‰é™„ä»¶å¹¶é‡å»º Release (Critical)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==================== å®Œæˆé€šçŸ¥ ====================
      - name: å®Œæˆ
        run: |
          echo "=========================================="
          echo "ğŸ¯ ç›®æ ‡æ ‡ç­¾: ${{ inputs.target_tag }}"
          echo "ğŸ“Œ é—®é¢˜ç±»å‹: ${{ inputs.issue_type }}"
          echo "ğŸ“ å‚è€ƒä¿¡æ¯: ${{ inputs.reference || 'æ— ' }}"
          echo "=========================================="
          echo "âœ… ç´§æ€¥æ¸…ç†å®Œæˆï¼"
