# ========================================
# GKI å†…æ ¸æ„å»ºä¸»å…¥å£
# ========================================
# æ­¤å·¥ä½œæµæ˜¯é¡¹ç›®çš„ç»Ÿä¸€å…¥å£ç‚¹ï¼Œç”¨äºï¼š
# 1. æ„å»ºæ‰€æœ‰ç‰ˆæœ¬çš„ GKI å†…æ ¸
# 2. è·å–æœ€æ–°çš„ KSU ç®¡ç†å™¨
# 3. æ”¶é›†è¡¥ä¸å†²çªæ–‡ä»¶ç”¨äºè°ƒè¯•
# 4. åˆ›å»º GitHub Release (å¯é€‰)
# ========================================

name: æ„å»ºå†…æ ¸

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€åˆ†æ”¯åªè¿è¡Œä¸€ä¸ªå®ä¾‹ï¼Œæ–°è¿è¡Œä¼šå–æ¶ˆæ—§çš„
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      # ==================== å‘å¸ƒé…ç½® ====================
      release_type:
        description: "å‘å¸ƒç±»å‹"
        type: choice
        options:
          - Actions
          - Pre-Release
          - Release
        default: Actions

      # ==================== KernelSU é…ç½® ====================
      kernelsu_variant:
        description: "KernelSU å˜ä½“"
        type: choice
        options:
          - SukiSU
          - ReSukiSU
          - Official
          - Next
          - MKSU
        default: SukiSU
      kernelsu_branch:
        description: "KSU åˆ†æ”¯"
        type: choice
        options:
          - Stable(æ ‡å‡†)
          - Dev(å¼€å‘)
        default: Stable(æ ‡å‡†)

      # ==================== å¯é€‰é…ç½® ====================
      version:
        description: "è‡ªå®šä¹‰ç‰ˆæœ¬å (å¯é€‰)"
        type: string
        default: ""
        required: false
      # ==================== åŠŸèƒ½å¼€å…³ ====================
      use_zram:
        description: "å¯ç”¨ ZRAM å¢å¼ºç®—æ³•"
        type: boolean
        default: true
      use_bbg:
        description: "å¯ç”¨ BBG é˜²æ ¼æœº"
        type: boolean
        default: true
      use_kpm:
        description: "å¯ç”¨ KPM åŠŸèƒ½"
        type: boolean
        default: true
      cancel_susfs:
        description: "ç¦ç”¨ SUSFS"
        type: boolean
        default: false

      # ==================== æ„å»ºç‰ˆæœ¬é€‰æ‹© ====================
      build_a12_5_10:
        description: "Android 12 - 5.10"
        type: boolean
        default: false
      build_a13_5_15:
        description: "Android 13 - 5.15"
        type: boolean
        default: false
      build_a14_6_1:
        description: "Android 14 - 6.1"
        type: boolean
        default: false
      build_a15_6_6:
        description: "Android 15 - 6.6"
        type: boolean
        default: false
      build_all:
        description: "æ„å»ºå…¨éƒ¨ç‰ˆæœ¬"
        type: boolean
        default: true

jobs:
  # ==================== è·å–ç®¡ç†å™¨ ====================
  # ä¸‹è½½æœ€æ–°çš„ KernelSU ç®¡ç†å™¨ APK å’Œ SUSFS æ¨¡å—
  get-manager:
    uses: ./.github/workflows/get-manager.yml
    secrets: inherit
    with:
      kernelsu_variant: ${{ inputs.kernelsu_variant }}

  # ==================== Android 12 - 5.10 æ„å»º ====================
  build-a12-5-10:
    if: inputs.build_a12_5_10 || inputs.build_all
    uses: ./.github/workflows/kernel-a12-5-10.yml
    secrets: inherit
    with:
      kernelsu_variant: ${{ inputs.kernelsu_variant }}
      kernelsu_branch: ${{ inputs.kernelsu_branch }}
      version: ${{ inputs.version }}
      use_zram: ${{ inputs.use_zram }}
      use_bbg: ${{ inputs.use_bbg }}
      use_kpm: ${{ inputs.use_kpm }}
      cancel_susfs: ${{ inputs.cancel_susfs }}
      called_from_main: true

  # ==================== Android 13 - 5.15 æ„å»º ====================
  build-a13-5-15:
    if: inputs.build_a13_5_15 || inputs.build_all
    uses: ./.github/workflows/kernel-a13-5-15.yml
    secrets: inherit
    with:
      kernelsu_variant: ${{ inputs.kernelsu_variant }}
      kernelsu_branch: ${{ inputs.kernelsu_branch }}
      version: ${{ inputs.version }}
      use_zram: ${{ inputs.use_zram }}
      use_bbg: ${{ inputs.use_bbg }}
      use_kpm: ${{ inputs.use_kpm }}
      cancel_susfs: ${{ inputs.cancel_susfs }}
      called_from_main: true

  # ==================== Android 14 - 6.1 æ„å»º ====================
  build-a14-6-1:
    if: inputs.build_a14_6_1 || inputs.build_all
    uses: ./.github/workflows/kernel-a14-6-1.yml
    secrets: inherit
    with:
      kernelsu_variant: ${{ inputs.kernelsu_variant }}
      kernelsu_branch: ${{ inputs.kernelsu_branch }}
      version: ${{ inputs.version }}
      use_zram: ${{ inputs.use_zram }}
      use_bbg: ${{ inputs.use_bbg }}
      use_kpm: ${{ inputs.use_kpm }}
      cancel_susfs: ${{ inputs.cancel_susfs }}
      called_from_main: true

  # ==================== Android 15 - 6.6 æ„å»º ====================
  build-a15-6-6:
    if: inputs.build_a15_6_6 || inputs.build_all
    uses: ./.github/workflows/kernel-a15-6-6.yml
    secrets: inherit
    with:
      kernelsu_variant: ${{ inputs.kernelsu_variant }}
      kernelsu_branch: ${{ inputs.kernelsu_branch }}
      version: ${{ inputs.version }}
      use_zram: ${{ inputs.use_zram }}
      use_bbg: ${{ inputs.use_bbg }}
      use_kpm: ${{ inputs.use_kpm }}
      cancel_susfs: ${{ inputs.cancel_susfs }}
      called_from_main: true

  # ==================== æ”¶é›†è¡¥ä¸å†²çªæ–‡ä»¶ ====================
  # æ±‡æ€»æ‰€æœ‰æ„å»ºä»»åŠ¡ä¸­çš„ .rej æ–‡ä»¶ï¼Œæ–¹ä¾¿è°ƒè¯•è¡¥ä¸é—®é¢˜
  collect-rejects:
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    needs:
      - build-a12-5-10
      - build-a13-5-15
      - build-a14-6-1
      - build-a15-6-6
    steps:
      - name: ä¸‹è½½å†²çªæ–‡ä»¶
        uses: actions/download-artifact@v4
        with:
          path: ./downloaded-artifacts
          pattern: '*-Rejects'

      - name: å¤„ç†å†²çªæ–‡ä»¶
        run: |
          mkdir -p aio-rejects
          for dir in ./downloaded-artifacts/*-Rejects; do
            [ -d "$dir" ] || continue
            dirname=$(basename "$dir")
            original_name=${dirname%-Rejects}
            mkdir -p "aio-rejects/$original_name"
            cp -r "$dir/." "aio-rejects/$original_name/"
          done
          if [ "$(ls -A aio-rejects 2>/dev/null)" ]; then
            cd aio-rejects && zip -r -q -9 ../AIO-REJ.zip . && cd ..
          fi

      - name: ä¸Šä¼ æ±‡æ€»å†²çªæ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: AIO-REJ
          path: AIO-REJ.zip
          if-no-files-found: ignore

  # ==================== åˆ›å»ºå‘å¸ƒ ====================
  # å½“ release_type ä¸æ˜¯ Actions æ—¶ï¼Œåˆ›å»º GitHub Release
  # ä»…é™åŸä»“åº“è¿è¡Œï¼Œfork ä»“åº“è·³è¿‡æ­¤æ­¥éª¤
  release:
    if: ${{ always() && !cancelled() && inputs.release_type != 'Actions' && github.repository == 'zzh20188/GKI_KernelSU_SUSFS' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    needs:
      - get-manager
      - build-a12-5-10
      - build-a13-5-15
      - build-a14-6-1
      - build-a15-6-6

    # ==================== ç¯å¢ƒå˜é‡ ====================
    env:
      REPO_OWNER: ${{ github.repository_owner }}
      REPO_NAME: ${{ github.event.repository.name }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # ==================== è®¾ç½®æ˜¾ç¤ºåç§° ====================
      # é¢„è®¡ç®—å„ç§æ˜¾ç¤ºåç§°ï¼Œç®€åŒ–åç»­å¼•ç”¨
      - name: è®¾ç½®æ˜¾ç¤ºåç§°
        run: |
          # KSU æ˜¾ç¤ºåç§°
          case "${{ inputs.kernelsu_variant }}" in
            "Next")      KSU_NAME="KernelSU-Next" ;;
            "Official")  KSU_NAME="KernelSU" ;;
            "MKSU")      KSU_NAME="MKSU" ;;
            "SukiSU")    KSU_NAME="SukiSU" ;;
            "ReSukiSU")  KSU_NAME="ReSukiSU" ;;
          esac
          echo "KSU_NAME=$KSU_NAME" >> $GITHUB_ENV

          # ç‰ˆæœ¬ä¿¡æ¯
          KSU_VER="${{ needs.get-manager.outputs.ksuVer }}"
          SUS_VER="${{ needs.get-manager.outputs.susVer }}"
          echo "KSU_VER=$KSU_VER" >> $GITHUB_ENV
          echo "SUS_VER=$SUS_VER" >> $GITHUB_ENV

          # åŠŸèƒ½å¼€å…³æ˜¾ç¤º
          echo "LZ4_STATUS=${{ inputs.use_zram && 'å¼€å¯' || 'æœªå¼€å¯' }}" >> $GITHUB_ENV
          echo "BBG_STATUS=${{ inputs.use_bbg && 'æ”¯æŒ' || 'ä¸æ”¯æŒ' }}" >> $GITHUB_ENV
          echo "KPM_LINE=${{ inputs.use_kpm && '-> KPM æ”¯æŒ' || '' }}" >> $GITHUB_ENV
          echo "LZ4_SUFFIX=${{ inputs.use_zram && 'ã€LZ4KD' || '' }}" >> $GITHUB_ENV

          # Hook ç±»å‹
          if [ "${{ inputs.kernelsu_variant }}" = "SukiSU" ] || [ "${{ inputs.kernelsu_variant }}" = "ReSukiSU" ]; then
            echo "HOOK_TYPE=-> SUSFS Inline Hooks" >> $GITHUB_ENV
          else
            echo "HOOK_TYPE=-> KPROBE Hooks" >> $GITHUB_ENV
          fi

          # Mount ç±»å‹
          if [ "${{ inputs.kernelsu_variant }}" = "Official" ]; then
            echo "MOUNT_TYPE=-> OVERLAYFS æ”¯æŒ" >> $GITHUB_ENV
            echo "KSU_SUFFIX=åŸç‰ˆ" >> $GITHUB_ENV
          else
            echo "MOUNT_TYPE=-> Magic Mount æ”¯æŒ" >> $GITHUB_ENV
            echo "KSU_SUFFIX=" >> $GITHUB_ENV
          fi

          # åˆ†æ”¯æ˜¾ç¤º
          if [ "${{ inputs.kernelsu_branch }}" = "Dev(å¼€å‘)" ]; then
            echo "BRANCH_INFO=($KSU_VER)" >> $GITHUB_ENV
          else
            echo "BRANCH_INFO=ç¨³å®šç‰ˆ" >> $GITHUB_ENV
          fi

          # å‘å¸ƒæ ‡é¢˜
          echo "RELEASE_NAME=GKIå†…æ ¸: ${KSU_NAME}(${KSU_VER}) & SUSFS ${SUS_VER}" >> $GITHUB_ENV

      # ==================== éªŒè¯æ„å»ºçŠ¶æ€ ====================
      # ç¡®ä¿æ‰€æœ‰é€‰ä¸­çš„æ„å»ºä»»åŠ¡éƒ½æˆåŠŸå®Œæˆ
      - name: éªŒè¯æ„å»ºçŠ¶æ€
        run: |
          failed=0
          check_build() {
            local selected="$1" job_name="$2" result="$3"
            if [[ "$selected" == "true" && "$result" != "success" && "$result" != "skipped" ]]; then
              echo "é€‰ä¸­çš„æ„å»ºä»»åŠ¡ $job_name å¤±è´¥ (ç»“æœ: $result)"
              failed=1
            fi
          }
          check_build "${{ inputs.build_a12_5_10 || inputs.build_all }}" "build-a12-5-10" "${{ needs.build-a12-5-10.result }}"
          check_build "${{ inputs.build_a13_5_15 || inputs.build_all }}" "build-a13-5-15" "${{ needs.build-a13-5-15.result }}"
          check_build "${{ inputs.build_a14_6_1 || inputs.build_all }}" "build-a14-6-1" "${{ needs.build-a14-6-1.result }}"
          check_build "${{ inputs.build_a15_6_6 || inputs.build_all }}" "build-a15-6-6" "${{ needs.build-a15-6-6.result }}"
          [[ "$failed" -ne 0 ]] && exit 1 || true

      # ==================== æ£€å‡ºä»£ç  ====================
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ==================== ç¡®å®š KSU åˆ†æ”¯ ====================
      # æ ¹æ®ç”¨æˆ·é€‰æ‹©ç¡®å®šå®é™…çš„ Git åˆ†æ”¯
      - name: ç¡®å®š KSU åˆ†æ”¯
        if: inputs.kernelsu_branch == 'Dev(å¼€å‘)' || inputs.kernelsu_variant == 'MKSU' || inputs.kernelsu_variant == 'SukiSU' || inputs.kernelsu_variant == 'ReSukiSU'
        run: |
          case "${{ inputs.kernelsu_variant }}" in
            "Official"|"MKSU") BRANCH="main" ;;
            "SukiSU"|"ReSukiSU") BRANCH="main" ;;
            "Next") BRANCH="dev" ;;
            *) echo "é”™è¯¯: æœªçŸ¥å˜ä½“" >&2; exit 1 ;;
          esac
          echo "KSU_BRANCH=$BRANCH" >> $GITHUB_ENV

      # ==================== è·å– KernelSU æäº¤ä¿¡æ¯ ====================
      # è·å–å½“å‰ä½¿ç”¨çš„ KernelSU ç‰ˆæœ¬çš„ Git æäº¤ä¿¡æ¯
      - name: è·å– KernelSU æäº¤ä¿¡æ¯
        run: |
          case "${{ inputs.kernelsu_variant }}" in
            "Official") REPO_URL="https://github.com/tiann/KernelSU.git"; REPO_URL2="tiann/KernelSU" ;;
            "Next") REPO_URL="https://github.com/KernelSU-Next/KernelSU-Next.git"; REPO_URL2="KernelSU-Next/KernelSU-Next" ;;
            "MKSU") REPO_URL="https://github.com/5ec1cff/KernelSU.git"; REPO_URL2="5ec1cff/KernelSU" ;;
            "SukiSU") REPO_URL="https://github.com/SukiSU-Ultra/SukiSU-Ultra.git"; REPO_URL2="SukiSU-Ultra/SukiSU-Ultra" ;;
            "ReSukiSU") REPO_URL="https://github.com/ReSukiSU/ReSukiSU.git"; REPO_URL2="ReSukiSU/ReSukiSU" ;;
          esac

          if [[ "${{ inputs.kernelsu_branch }}" == "Stable(æ ‡å‡†)" && "${{ inputs.kernelsu_variant }}" != "MKSU" ]]; then
            TAG=$(git ls-remote --tags --sort=-v:refname $REPO_URL | grep -o 'refs/tags/.*' | cut -d'/' -f3 | head -n1)
            KSU_REF=$TAG
            KSU_URL="https://github.com/$REPO_URL2/releases/tag/$TAG"
          else
            COMMIT_HASH=$(git ls-remote $REPO_URL refs/heads/${KSU_BRANCH:-main} | awk '{ print $1 }')
            KSU_REF=$COMMIT_HASH
            KSU_URL="https://github.com/$REPO_URL2/commit/$COMMIT_HASH"
          fi

          echo "KSU_REF=$KSU_REF" >> $GITHUB_ENV
          echo "KSU_URL=$KSU_URL" >> $GITHUB_ENV

      # ==================== è·å– SUSFS æäº¤ä¿¡æ¯ ====================
      # è·å–å„ç‰ˆæœ¬ SUSFS çš„ Git æäº¤ä¿¡æ¯
      - name: è·å– SUSFS æäº¤ä¿¡æ¯
        run: |
          GITLAB_OWNER="simonpunk"
          GITLAB_REPO="susfs4ksu"
          declare -A BRANCH_MAP=(
            ["gki_android12_5_10"]="gki-android12-5.10"
            ["gki_android13_5_15"]="gki-android13-5.15"
            ["gki_android14_6_1"]="gki-android14-6.1"
            ["gki_android15_6_6"]="gki-android15-6.6"
          )
          for var_name in "${!BRANCH_MAP[@]}"; do
            branch_name="${BRANCH_MAP[$var_name]}"
            COMMIT_HASH=$(git ls-remote https://gitlab.com/$GITLAB_OWNER/$GITLAB_REPO.git refs/heads/$branch_name | awk '{ print $1 }')
            if [[ -n "$COMMIT_HASH" ]]; then
              COMMIT_URL="https://gitlab.com/$GITLAB_OWNER/$GITLAB_REPO/-/commit/$COMMIT_HASH"
              echo "COMMIT_HASH_${var_name}=$COMMIT_HASH" >> "$GITHUB_ENV"
              echo "COMMIT_URL_${var_name}=$COMMIT_URL" >> "$GITHUB_ENV"
            fi
          done

      # ==================== ç”Ÿæˆå‘å¸ƒè¯´æ˜ ====================
      # åˆ›å»ºåŒ…å«è¯¦ç»†ä¿¡æ¯çš„å‘å¸ƒè¯´æ˜æ–‡æ¡£
      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        run: |
          cat > release_body.md << EOF
          ## ğŸ“¦ æœ¬æ¬¡å‘å¸ƒå†…å®¹ / Release Contents

          **${{ env.KSU_NAME }}** + **SUSFS ${{ env.SUS_VER }}**${{ env.LZ4_SUFFIX }}

          ### âœ¨ åŠŸèƒ½ç‰¹æ€§ / Features

          | ç»„ä»¶ / Component | çŠ¶æ€ / Status |
          |:---|:---|
          | ${{ env.KSU_NAME }} | ${{ env.KSU_SUFFIX }}${{ env.BRANCH_INFO }} |
          | SUSFS | à¶ ${{ env.SUS_VER }} |
          | BBG å®‰å…¨è¡¥ä¸ | ${{ env.BBG_STATUS }} |
          | LZ4KD & ONEPLUS_LZ4K | ${{ env.LZ4_STATUS }} |
          | LZ4 | v1.10.0 ${{ env.LZ4_STATUS }} |

          ${{ env.HOOK_TYPE }}
          ${{ env.MOUNT_TYPE }}
          ${{ env.KPM_LINE }} 

          > ğŸ’¡ [Unicode é›¶å®½ç»•è¿‡ä¿®å¤](https://t.me/real5ec1cff/268) - è¯·ä½¿ç”¨ Xposed æ¨¡å—

          ### ğŸ“¥ æ¨èæ¨¡å— / Recommended Module

          - https://github.com/sidex15/ksu_module_susfs

          ---

          > [!IMPORTANT]
          > ### âš ï¸ é£é™©å£°æ˜ / Risk Disclaimer
          >
          > æœ¬é¡¹ç›®æ•´åˆäº†å¤šä¸ª**æ´»è·ƒç»´æŠ¤çš„ä¸Šæ¸¸ç»„ä»¶**ï¼Œç”±äºå„ç»„ä»¶æ›´æ–°é¢‘ç¹ä¸”ç›¸äº’ä¾èµ–ï¼Œ**å¯èƒ½å‡ºç°ä»¥ä¸‹é—®é¢˜**ï¼š
          >
          > - ğŸ”„ æ— é™é‡å¯ (Bootloop)
          > - ğŸ› åŠŸèƒ½å¼‚å¸¸æˆ–ç³»ç»Ÿä¸ç¨³å®š
          >
          > **åˆ·å…¥å‰è¯·åŠ¡å¿…ï¼š**
          > 1. å¤‡ä»½åŸå‚ Boot é•œåƒï¼Œç¡®ä¿å¯éšæ—¶æ¢å¤
          > 2. è®°å½•å½“å‰æ—¶é—´ï¼Œä¾¿äºæ—¥å¿—åˆ†æ
          >
          > ---
          >
          > This project integrates multiple **actively maintained upstream components**. Due to frequent updates and dependencies, **the following issues may occur**:
          >
          > - ğŸ”„ Bootloop
          > - ğŸ› Functional issues or system instability
          >
          > **Before flashing, please ensure:**
          > 1. Backup your stock boot image for recovery
          > 2. Note the current time for log analysis

          <details>
          <summary>ğŸ“‹ åˆ·å…¥åæŒ‡å— / Post-Flash Guide</summary>

          #### âœ… å¦‚æœæ­£å¸¸å¯åŠ¨ / If Boot Successful

          æ­å–œï¼äº«å—ä½ çš„æ–°å†…æ ¸å§ ğŸ‰

          Congratulations! Enjoy your new kernel ğŸ‰

          #### âŒ å¦‚æœæ— æ³•å¯åŠ¨ / If Boot Failed

          1. æ¢å¤åŸå‚ Boot é•œåƒ
          2. ä½¿ç”¨ KernelSU ç®¡ç†å™¨æå–å†…æ ¸æ—¥å¿—
          3. å°†æ—¥å¿—æäº¤åˆ° [Issues](https://github.com/zzh20188/GKI_KernelSU_SUSFS/issues) æˆ–å’¨è¯¢ä¸“ä¸šäººå£«

          1. Restore stock boot image
          2. Extract kernel logs using KernelSU Manager
          3. Submit logs to [Issues](https://github.com/zzh20188/GKI_KernelSU_SUSFS/issues) or consult experts

          </details>

          ---

          <details>
          <summary>ğŸ”— æäº¤ä¿¡æ¯ / Commit Info</summary>

          **KernelSU (${{ inputs.kernelsu_variant }})**: [${{ env.KSU_REF }}](${{ env.KSU_URL }})

          **SUSFS4KSU**:
          - gki-android12-5.10: [${{ env.COMMIT_HASH_gki_android12_5_10 }}](${{ env.COMMIT_URL_gki_android12_5_10 }})
          - gki-android13-5.15: [${{ env.COMMIT_HASH_gki_android13_5_15 }}](${{ env.COMMIT_URL_gki_android13_5_15 }})
          - gki-android14-6.1: [${{ env.COMMIT_HASH_gki_android14_6_1 }}](${{ env.COMMIT_URL_gki_android14_6_1 }})
          - gki-android15-6.6: [${{ env.COMMIT_HASH_gki_android15_6_6 }}](${{ env.COMMIT_URL_gki_android15_6_6 }})

          </details>

          ---

          **LTO**: thin

          ğŸ“‚ ç‚¹å‡»ä¸‹æ–¹ **Assets** å±•å¼€ä¸‹è½½ / Click **Assets** below to download
          EOF

      # ==================== ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾ ====================
      # æ ¹æ® SUSFS ç‰ˆæœ¬ç”Ÿæˆé€’å¢çš„å‘å¸ƒæ ‡ç­¾
      - name: ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
        run: |
          # è·å– SUSFS ç‰ˆæœ¬ï¼Œå¦‚æœ get-manager è¢«è·³è¿‡åˆ™ä½¿ç”¨é»˜è®¤å€¼
          SUS_VERSION="${{ needs.get-manager.outputs.susVer }}"
          if [ -z "$SUS_VERSION" ]; then
            echo "è­¦å‘Š: æœªè·å–åˆ° SUSFS ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬å·"
            SUS_VERSION="1.0.0"
          fi

          LATEST_TAG=$(gh api repos/$REPO_OWNER/$REPO_NAME/tags --jq '.[0].name' 2>/dev/null | sed 's/-.*//' || echo "")

          if [ "$SUS_VERSION" = "$LATEST_TAG" ]; then
            LATEST_TAG=$(gh api repos/$REPO_OWNER/$REPO_NAME/tags --jq '.[0].name')
          else
            LATEST_TAG="$SUS_VERSION-r0"
          fi

          NEW_TAG=$(echo "$LATEST_TAG" | awk -F'-r' '{suffix=$2; if (!suffix) suffix=0; suffix++; printf "%s-r%d", $1, suffix}')
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

          git tag "$NEW_TAG"
          git push --tags

      # ==================== ä¸‹è½½æ„å»ºäº§ç‰© ====================
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ./downloaded-artifacts

      # ==================== åˆ›å»º GitHub Release ====================
      - name: åˆ›å»º GitHub Release
        run: |
          PRERELEASE_FLAG=""
          if [ "${{ inputs.release_type }}" == "Pre-Release" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "$NEW_TAG" \
            --title "${{ env.RELEASE_NAME }}" \
            --notes-file release_body.md \
            $PRERELEASE_FLAG

      # ==================== ä¸Šä¼ ç®¡ç†å™¨å’Œæ¨¡å— ====================
      - name: ä¸Šä¼ ç®¡ç†å™¨å’Œ SUSFS æ¨¡å—
        continue-on-error: true
        run: |
          echo "å‡†å¤‡ä¸Šä¼  APK ä¸ SUSFS æ¨¡å—..."
          apk_count=$(find ./downloaded-artifacts -type f -name "*.apk" | wc -l || true)
          sus_count=$(find ./downloaded-artifacts -type f -path "./downloaded-artifacts/susfs-*/*" | wc -l || true)
          echo "APK files: ${apk_count}"
          echo "SUSFS files: ${sus_count}"
          find ./downloaded-artifacts -type f -name "*.apk" -print0 | \
          while IFS= read -r -d '' f; do
            gh release upload "$NEW_TAG" "$f" || true
          done
          find ./downloaded-artifacts -type f -path "./downloaded-artifacts/susfs-*/*" -print0 | \
          while IFS= read -r -d '' f; do
            gh release upload "$NEW_TAG" "$f" || true
          done

      # ==================== ä¸Šä¼ å†…æ ¸äº§ç‰© ====================
      - name: ä¸Šä¼ å†…æ ¸äº§ç‰©
        run: |
          for file in ./downloaded-artifacts/*_kernel-*/*; do
            [ -d "$file" ] && continue
            # è·³è¿‡ -Rejects ç›®å½•ä¸­çš„æ–‡ä»¶ï¼ˆå·²åœ¨ collect-rejects ä¸­æ±‡æ€»å¤„ç†ï¼‰
            [[ "$file" == *-Rejects/* ]] && continue
            echo "ä¸Šä¼  $file..."
            gh release upload "$NEW_TAG" "$file"
          done

      # ==================== æ„å»ºæ‘˜è¦ ====================
      - name: æ„å»ºæ‘˜è¦
        run: |
          echo "## å‘å¸ƒå·²åˆ›å»º" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ‡ç­¾**: $NEW_TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **ç±»å‹**: ${{ inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é“¾æ¥**: https://github.com/$REPO_OWNER/$REPO_NAME/releases/tag/$NEW_TAG" >> $GITHUB_STEP_SUMMARY
