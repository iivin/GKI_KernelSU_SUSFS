name: GetManager
permissions:
  contents: write  # Allow writing to repository contents (for pushing tags)
  actions: read   # Allows triggering actions

on:
  workflow_call: # This allows this workflow to be called from another workflow
    inputs:
      kernelsu_variant:
        required: true
        type: string
    outputs:
      susVer:
        description: "The fetched SUSFS version number"
        value: ${{ jobs.get_ksu_manager.outputs.susVer }}

      ksuVer:
        description: "The calculated KSU version number"
        value: ${{ jobs.get_ksu_manager.outputs.ksuVer }}

jobs:
  get_ksu_manager:
    runs-on: ubuntu-latest
    outputs:
      # è¾“å‡º1: KSUç‰ˆæœ¬å·
      ksuVer: ${{ steps.get_version.outputs.kversion }}
      # è¾“å‡º2: SUSFSç‰ˆæœ¬å·
      susVer: ${{ steps.get_version.outputs.sversion }}
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: ğŸ§ Debug Workflow Caller Context
        run: |
          echo "==================== DEBUG CONTEXT ===================="
          echo " "
          echo "EVENT NAME: ${{ github.event_name }}"
          echo " "
          echo "--- CALLER INFORMATION ---"
          echo "  - Caller Repository: ${{ github.caller_repository }}"
          echo "  - Caller Workflow:   ${{ github.caller_workflow }}"
          echo "  - Caller User:       ${{ github.triggering_actor }}"
          echo " "
          echo "--- WORKFLOW & JOB INFORMATION ---"
          echo "  - Current Workflow:  ${{ github.workflow }}"
          echo "  - Current Job ID:    ${{ github.job }}"
          echo "  - Current Run ID:    ${{ github.run_id }}"
          echo "  - Current Run Number:${{ github.run_number }}"
          echo " "
          echo "--- GIT REFERENCE INFORMATION ---"
          echo "  - Git Ref:           ${{ github.ref }}"
          echo "  - Ref Type:          ${{ github.ref_type }}"
          echo " "
          echo "======================================================="
          
      - name: å®‰è£…ä¾èµ–
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: git curl jq
          execute_install_scripts: true

      - name: è·å– KSU & SUSFS ç‰ˆæœ¬
        id: get_version
        run: |

          if [ "${{ inputs.kernelsu_variant }}" == "Next" ]; then
            echo "This is the Next variant"
            git clone https://github.com/KernelSU-Next/KernelSU-Next.git KernelSU
          elif [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            echo "This is the SukiSU variant"
            git clone https://github.com/SukiSU-Ultra/SukiSU-Ultra.git KernelSU
          elif [ "${{ inputs.kernelsu_variant }}" == "ReSukiSU" ]; then
            echo "This is the ReSukiSU variant"
            git clone https://github.com/ReSukiSU/ReSukiSU.git KernelSU
          elif [ "${{ inputs.kernelsu_variant }}" == "Official" ]; then
            echo "This is the Official"
            git clone https://github.com/tiann/KernelSU.git KernelSU
          elif [ "${{ inputs.kernelsu_variant }}" == "MKSU" ]; then
            echo "This is the Official"
            git clone https://github.com/5ec1cff/KernelSU.git KernelSU
          else
            echo "Unknown variant"
          fi

          VAR=$([[ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]] && echo 700 || echo 200)

          cd KernelSU

          # è®¡ç®—KSUç‰ˆæœ¬å·
          KSU_GIT_VERSION=$(git rev-list --count HEAD)

          if [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            KSU_VERSION=$((40000 + KSU_GIT_VERSION - 2815))
          elif [ "${{ inputs.kernelsu_variant }}" == "ReSukiSU" ]; then
            KSU_VERSION=$((30700 + KSU_GIT_VERSION))
          elif [ "${{ inputs.kernelsu_variant }}" == "Official" ] || [ "${{ inputs.kernelsu_variant }}" == "MKSU" ]; then
            KSU_VERSION=$((20000 + KSU_GIT_VERSION))
          elif [ "${{ inputs.kernelsu_variant }}" == "Next" ]; then
            KSU_VERSION=$((30000 + KSU_GIT_VERSION))
          fi
          echo $KSU_VERSION
          echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV

          # è®¡ç®—SUSFSç‰ˆæœ¬å·
          INFO="https://gitlab.com/simonpunk/susfs4ksu/-/raw/gki-android14-6.1/ksu_module_susfs/module.prop\?ref_type\=heads"
          SUS_VERSION=$(curl -s $INFO | awk -F '=' '$1 == "version" { print $2 }')
          echo $SUS_VERSION

          # å¯¼å‡ºè¿™ä¸¤ä¸ªå€¼ç»™release
          echo "kversion=$KSU_VERSION" >> $GITHUB_OUTPUT
          echo "sversion=$SUS_VERSION" >> $GITHUB_OUTPUT

      - name: æ·»åŠ  KernelSU
        id: add_KSU
        continue-on-error: true
        run: |
          if [ "${{ inputs.kernelsu_variant }}" == "Next" ]; then
            echo "KernelSU Next..."
            REPO="KernelSU-Next/KernelSU-Next"
            KSUM="manager"
          elif [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            echo "SukiSU..."
            REPO="SukiSU-Ultra/SukiSU-Ultra"
            KSUM="Manager"
          elif [ "${{ inputs.kernelsu_variant }}" == "ReSukiSU" ]; then
            echo "ReSukiSU..."
            REPO="ReSukiSU/ReSukiSU"
            KSUM="Manager"
          elif [ "${{ inputs.kernelsu_variant }}" == "MKSU" ]; then
            echo "MKSU..."
            REPO="5ec1cff/KernelSU"
            KSUM="manager"
          elif [ "${{ inputs.kernelsu_variant }}" == "Official" ]; then
            echo "KSU..."
            REPO="tiann/KernelSU"
            KSUM="manager"
          fi

          FILENAME=$([[ "${{ inputs.kernelsu_variant }}" == "Next" ]] && echo "build-manager-ci.yml" || echo "build-manager.yml")
          
          
          # åˆå§‹åŒ–
          NUMBER=0
          DOWNLOAD_LIST=""

          echo "å¼€å§‹æŸ¥æ‰¾åŒ…å« 'manager' äº§ç‰©çš„æ„å»º..."
          while true; do
            echo "--------------------------------------------------"
            echo "æ­£åœ¨æ£€æŸ¥ç¬¬ ${NUMBER} ä¸ªå†å²æ„å»º (0ä»£è¡¨æœ€æ–°)..."

            if [ "$NUMBER" -ge 9 ]; then
              echo "æŸ¥æ‰¾ä¹æ¬¡ä»ç„¶å¤±è´¥ï¼Œè·³å‡ºå¾ªç¯ã€‚"
              break
            fi

            # 1. è·å–æŒ‡å®šé¡ºåºçš„æˆåŠŸæ„å»ºçš„ID

            BUILD_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$REPO/actions/workflows/$FILENAME/runs?status=success" |
              jq -r '.workflow_runs['"$NUMBER"'].id')

            echo "æ‰¾åˆ°æ„å»º ID: $BUILD_ID"

            ARTIFACTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$REPO/actions/runs/$BUILD_ID/artifacts")

            result=$(echo "$ARTIFACTS" | jq -r '.artifacts[] | select(.name | contains("'"$KSUM"'")) | .name')

            if [ -z "$result" ]; then
              echo "æ²¡æœ‰æ‰¾åˆ°åŒ…å« '$KSUM' çš„é¡¹"
              NUMBER=$((NUMBER + 1))
            else
              echo "$result"
              DOWNLOAD_LIST=$(echo "$ARTIFACTS" | jq -r '.artifacts[] | select(.name | contains("'"$KSUM"'")) | "\(.name)\t\(.archive_download_url)"')
              break
            fi

          done
         
          if [ -z "$DOWNLOAD_LIST" ]; then
            echo "æœªè·å–åˆ°å¯ç”¨çš„ Manager artifact ä¸‹è½½åœ°å€åˆ—è¡¨ã€‚"
            exit 1
          fi
          
          # ä¸‹è½½å¹¶è§£å‹æ‰€æœ‰ Manager äº§ç‰©
          echo "$DOWNLOAD_LIST" | while IFS=$'\t' read -r NAME URL; do
            SAFE_NAME=$(echo "$NAME" | tr '/ ' '__')
            ZIP_NAME="${{ inputs.kernelsu_variant }}-${SAFE_NAME}(${{ env.KSU_VERSION }}).zip"
            echo "ä¸‹è½½ $NAME -> $ZIP_NAME"
            curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o "$ZIP_NAME" "$URL"
            mkdir -p "manager-artifacts/$SAFE_NAME"
            unzip -o "$ZIP_NAME" -d "manager-artifacts/$SAFE_NAME"
            rm -rf "$ZIP_NAME"
          done

      - name: æ·»åŠ  SUSFS æ¨¡å—
        id: add_SUSFS
        continue-on-error: true
        run: |
          BUILD_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/workflows/build.yml/runs?status=success" |
          jq -r '.workflow_runs[0].id')

          ARTIFACTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/runs/$BUILD_ID/artifacts")

          DOWNLOAD_URL=$(echo "$ARTIFACTS" | jq -r '.artifacts[0].archive_download_url') 

          NAME=$(echo "$ARTIFACTS" | jq -r '.artifacts[0].name')
          echo "SUSFS_NAME=$NAME" >> $GITHUB_ENV
          NAME="susfs-$NAME.zip"
          
          echo $DOWNLOAD_URL
          echo $NAME
          # ä¸‹è½½ Manager æ–‡ä»¶
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o "$NAME" "$DOWNLOAD_URL"
          echo "$NAME æ–‡ä»¶å·²ä¸‹è½½.zip"
          
          
          # è§£å‹ artifact zip è·å–é‡Œé¢çš„æ¨¡å—æ–‡ä»¶
          mkdir -p susfs-module
          unzip "$NAME" -d susfs-temp

          # æ£€æŸ¥è§£å‹åçš„å†…å®¹ï¼šå¦‚æœæ˜¯æ•£è£…æ–‡ä»¶åˆ™æ‰“åŒ…æˆ zip
          cd susfs-temp
          if ls *.zip 1>/dev/null 2>&1; then
            # é‡Œé¢å·²ç»æ˜¯ zip æ–‡ä»¶ï¼Œç›´æ¥ç§»åŠ¨
            mv *.zip ../susfs-module/
          else
            # æ˜¯æ•£è£…æ–‡ä»¶ï¼Œæ‰“åŒ…æˆ zip
            zip -r "../susfs-module/ksu_module_susfs.zip" .
          fi
          cd ..
          rm -rf susfs-temp "$NAME"

      - name: Notify on failure
        if: steps.add_KSU.outcome == 'failure'
        run: echo "ä¸‹è½½CIæ„å»ºçš„KSUå¤±è´¥!"

      - name: ä¸Šä¼ APK
        if: steps.add_KSU.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.kernelsu_variant }}-Manager(${{ env.KSU_VERSION }})
          path: |
            **/*.apk

      - name: ä¸Šä¼ SUSFSæ¨¡å—
        if: steps.add_SUSFS.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: susfs-${{ env.SUSFS_NAME }}
          path: ./susfs-module/*
